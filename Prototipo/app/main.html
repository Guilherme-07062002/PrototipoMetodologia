<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda</title>
    <link rel="stylesheet" href="estilo.css">
    <link rel="stylesheet" href="webcam.css">
</head>

<body>

    <div class="title">
        <h1 class="moda">VERIFICADOR DE CORES</h1>
        <p class="text">Se posicione em frente a camera e iremos exibir uma paleta de cores que combina com o que você
            está usando.
        </p>
    </div>
    <div class="holder">
        <div class="holder2">
            <p id="legenda">Você vai aparecer aqui</p>
            <div id="webcam">
                <div id="cam">
                    <div id="webcam-container"></div>
                </div>
                <div id="label-container"></div>
            </div>

        </div>
        <div class="holder3">
            <p id="indica_cor">Sua cor</p>
        </div>
        <div class="buttons">
            <button onclick="printScreen()" class="download"><img src="/Prototipo/icons/dwld.svg"
                    alt="download"></button>
            <button onclick="init()" class="camera"><img src="/Prototipo/icons/cmr.svg" alt="camera"></button>
            <button onclick="stop()" class="close"><img src="/Prototipo/icons/close.svg" alt="close"></button>
        </div>
    </div>

    <footer></footer>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
        // Função pra parar execução
        function stop() {
            location.reload()
        }
        // Tirar print da tela
        function printScreen() {
            window.print('')
        }

        // Referenciando o link para o modelo
        const URL = "./src/my_model/";

        let model, webcam, labelContainer, maxPredictions;

        // Carregando modelo e configurando webcam
        async function init() {

            document.getElementById('legenda').style.display = 'none'
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";


            // Carrega o modelo e os metadados
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Configurando webcam
            const flip = true;
            webcam = new tmImage.Webcam(380, 380, flip); // Dimensões da janela da webcam
            await webcam.setup(); // Pede permissão para que a webcam seja inicializada
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) { // and class labels
                labelContainer.appendChild(document.createElement("div"));
            }
        }
        async function loop() {
            webcam.update(); // Atualiza frame da webcam
            await predict();
            window.requestAnimationFrame(loop);
        }

        // Inicializa webcam do navegador
        async function predict() {
            document.getElementById('indica_cor').style.display = 'inline'
            // Realiza previsão com base na imagem da webcam
            const prediction = await model.predict(webcam.canvas);
            let color1, color2, color3, color4, color5 = 0
            for (let i = 0; i < maxPredictions; i++) {
                let paleta = document.getElementsByClassName('holder3')[0]
                /*
                O modelo associa esses números com cada cor: 
                0-Vermelho: 
                1-Verde: 
                2-Azul: 
                3-Laranja: 
                4-Roxo: 
                5-Amarelo: 
                6-Rosa: 
                7-Preto: 
                 */
                // Se a taxa de acerto de previsão de x for maior que 90%...
                // Exiba a paleta com as cores correspondentes 
                if (prediction[0].probability.toFixed(2) > 0.90) {
                    console.log(prediction[i].className)
                    paleta.style.backgroundImage = 'url(../imgs/paletaVermelho.png)'
                } else if (prediction[2].probability.toFixed(2) > 0.90) {
                    console.log(prediction[i].className)
                    paleta.style.backgroundImage = 'url(../imgs/paletaAzul.png)'
                } else if (prediction[5].probability.toFixed(2) > 0.90) {
                    console.log(prediction[i].className)
                    paleta.style.backgroundImage = 'url(../imgs/paletaAmarelo.png)'
                }
            }
        }
    </script>
</body>

</html>